"""
Teste da funcionalidade de geraÃ§Ã£o de PDF
==========================================

Script para testar a geraÃ§Ã£o de PDF com anÃ¡lises SmartBI
"""

import asyncio
import os
import sys
from gemini_analyzer import GeminiAnalyzer

async def test_pdf_generation():
    """
    Testa a geraÃ§Ã£o de PDF com dados simulados
    """
    print("ğŸ§ª Iniciando teste de geraÃ§Ã£o de PDF...")
    
    try:
        # Inicializar o analisador
        analyzer = GeminiAnalyzer()
        
        # Dados de teste simulados
        test_data_content = """
        CREATE TABLE usuarios (
            id INT PRIMARY KEY,
            nome VARCHAR(100),
            email VARCHAR(100),
            data_criacao DATETIME
        );
        
        INSERT INTO usuarios VALUES 
        (1, 'JoÃ£o Silva', 'joao@email.com', '2024-01-01'),
        (2, 'Maria Santos', 'maria@email.com', '2024-01-02');
        """
        
        test_data_info = {
            "tables": 1,
            "records": 2,
            "source": "test"
        }
        
        print("ğŸ“Š Executando anÃ¡lise de teste...")
        
        # Executar anÃ¡lise
        result = await analyzer.analyze_data(
            data_content=test_data_content,
            data_info=test_data_info,
            file_type="sql"
        )
        
        # Verificar resultados
        print(f"âœ… AnÃ¡lise concluÃ­da em {result['processing_time']} segundos")
        print(f"ğŸ“ Resposta recebida: {len(result['gemini_response'])} caracteres")
        
        # Verificar PDF
        if result.get('pdf_generated'):
            pdf_path = result.get('pdf_path')
            print(f"ğŸ“„ PDF gerado com sucesso: {pdf_path}")
            
            # Verificar se o arquivo existe
            if os.path.exists(pdf_path):
                file_size = os.path.getsize(pdf_path) / 1024  # KB
                print(f"ğŸ“ Tamanho do PDF: {file_size:.1f} KB")
                
                # Mostrar diretÃ³rio de saÃ­da
                output_dir = analyzer.pdf_generator.get_output_directory()
                print(f"ğŸ“ PDFs salvos em: {output_dir}")
                
                # Listar todos os PDFs no diretÃ³rio
                pdf_files = [f for f in os.listdir(output_dir) if f.endswith('.pdf')]
                print(f"ğŸ“‹ Total de PDFs no diretÃ³rio: {len(pdf_files)}")
                
                return True
            else:
                print(f"âŒ Arquivo PDF nÃ£o encontrado: {pdf_path}")
                return False
        else:
            print(f"âŒ PDF nÃ£o foi gerado. Erro: {result.get('pdf_error', 'Desconhecido')}")
            return False
            
    except Exception as e:
        print(f"âŒ Erro no teste: {e}")
        return False

async def test_specific_insights_pdf():
    """
    Testa a geraÃ§Ã£o de PDF para insights especÃ­ficos
    """
    print("\nğŸ§ª Testando geraÃ§Ã£o de PDF para insights especÃ­ficos...")
    
    try:
        analyzer = GeminiAnalyzer()
        
        # Dados simulados de schema e amostra
        database_schema = {
            "total_tables": 2,
            "tables": {
                "vendas": {
                    "row_count": 100,
                    "column_count": 5,
                    "columns": [
                        {"name": "id", "type": "INT", "primary_key": True},
                        {"name": "produto", "type": "VARCHAR(100)"},
                        {"name": "valor", "type": "DECIMAL(10,2)"},
                        {"name": "data_venda", "type": "DATE"}
                    ]
                }
            }
        }
        
        sample_data = {
            "total_records": 100,
            "data": {
                "vendas": [
                    {"id": 1, "produto": "Produto A", "valor": 150.00, "data_venda": "2024-01-01"},
                    {"id": 2, "produto": "Produto B", "valor": 200.00, "data_venda": "2024-01-02"}
                ]
            }
        }
        
        insight_request = "AnÃ¡lise de vendas por produto"
        
        print("ğŸ“Š Executando anÃ¡lise de insights especÃ­ficos...")
        
        result = await analyzer.analyze_specific_insights(
            database_schema=database_schema,
            sample_data=sample_data,
            insight_request=insight_request
        )
        
        print(f"âœ… AnÃ¡lise de insights concluÃ­da em {result['processing_time']} segundos")
        
        if result.get('pdf_generated'):
            pdf_path = result.get('pdf_path')
            print(f"ğŸ“„ PDF de insights especÃ­ficos gerado: {pdf_path}")
            return True
        else:
            print(f"âŒ PDF de insights nÃ£o foi gerado. Erro: {result.get('pdf_error', 'Desconhecido')}")
            return False
            
    except Exception as e:
        print(f"âŒ Erro no teste de insights especÃ­ficos: {e}")
        return False

async def main():
    """
    Executa todos os testes
    """
    print("ğŸš€ Iniciando testes de geraÃ§Ã£o de PDF SmartBI\n")
    
    # Teste 1: AnÃ¡lise geral
    test1_success = await test_pdf_generation()
    
    # Teste 2: Insights especÃ­ficos
    test2_success = await test_specific_insights_pdf()
    
    print(f"\nğŸ“Š Resumo dos testes:")
    print(f"   AnÃ¡lise geral: {'âœ… Sucesso' if test1_success else 'âŒ Falhou'}")
    print(f"   Insights especÃ­ficos: {'âœ… Sucesso' if test2_success else 'âŒ Falhou'}")
    
    if test1_success and test2_success:
        print("\nğŸ‰ Todos os testes passaram! Funcionalidade de PDF funcionando corretamente.")
    else:
        print("\nâš ï¸ Alguns testes falharam. Verifique os logs acima.")

if __name__ == "__main__":
    asyncio.run(main())