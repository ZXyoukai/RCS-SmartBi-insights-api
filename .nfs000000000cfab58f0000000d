"""
Teste das rotas da API com URLs de PDF
====================================

Script para testar se as rotas estÃ£o retornando URLs pÃºblicas para os PDFs
"""

import requests
import json
import time

def test_analyze_database_with_pdf():
    """
    Testa a rota /analyze-database com verificaÃ§Ã£o das URLs de PDF
    """
    print("ğŸ§ª Testando rota /analyze-database com URLs de PDF...")
    
    url = "http://localhost:8000/analyze-database"
    payload = {
        "database_url": "postgresql://neondb_owner:iVdC1OxbWP99@ep-morning-hill-a5h6lsjm-pooler.us-east-2.aws.neon.tech/mapazzz?sslmode=require"
    }
    
    try:
        print("ğŸ“¡ Enviando requisiÃ§Ã£o...")
        response = requests.post(url, json=payload, timeout=120)
        
        if response.status_code == 200:
            data = response.json()
            print(f"âœ… Resposta recebida (Status: {response.status_code})")
            
            # Verificar informaÃ§Ãµes de PDF
            pdf_info = {
                "pdf_generated": data.get("pdf_generated"),
                "pdf_filename": data.get("pdf_filename"),
                "pdf_download_url": data.get("pdf_download_url"),
                "pdf_static_url": data.get("pdf_static_url"),
                "pdf_error": data.get("pdf_error")
            }
            
            print(f"ğŸ“„ PDF Info:")
            print(json.dumps(pdf_info, indent=2))
            
            if pdf_info["pdf_generated"]:
                print(f"ğŸ‰ PDF gerado com sucesso!")
                print(f"ğŸ“¥ Download URL: {pdf_info['pdf_download_url']}")
                print(f"ğŸ”— Static URL: {pdf_info['pdf_static_url']}")
                
                # Testar se as URLs estÃ£o acessÃ­veis
                if pdf_info["pdf_download_url"]:
                    test_url_response = requests.head(pdf_info["pdf_download_url"], timeout=10)
                    print(f"ğŸŒ URL Download acessÃ­vel: {'âœ…' if test_url_response.status_code == 200 else 'âŒ'}")
                
                if pdf_info["pdf_static_url"]:
                    test_url_response = requests.head(pdf_info["pdf_static_url"], timeout=10)
                    print(f"ğŸŒ URL Static acessÃ­vel: {'âœ…' if test_url_response.status_code == 200 else 'âŒ'}")
                
                return True
            else:
                print(f"âŒ PDF nÃ£o foi gerado. Erro: {pdf_info.get('pdf_error', 'Desconhecido')}")
                return False
                
        else:
            print(f"âŒ Erro na requisiÃ§Ã£o: {response.status_code}")
            print(f"Resposta: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Erro no teste: {e}")
        return False

def test_static_files():
    """
    Testa se os arquivos estÃ¡ticos estÃ£o sendo servidos corretamente
    """
    print("\nğŸ§ª Testando arquivos estÃ¡ticos...")
    
    try:
        # Testar se o diretÃ³rio reports estÃ¡ acessÃ­vel
        response = requests.get("http://localhost:8000/reports/", timeout=10)
        print(f"ğŸ“ Acesso ao diretÃ³rio reports: {'âœ…' if response.status_code in [200, 403] else 'âŒ'}")
        
        return response.status_code in [200, 403]  # 403 Ã© normal para listagem de diretÃ³rio
        
    except Exception as e:
        print(f"âŒ Erro ao testar arquivos estÃ¡ticos: {e}")
        return False

def test_health_endpoint():
    """
    Testa se o servidor estÃ¡ funcionando
    """
    try:
        response = requests.get("http://localhost:8000/health", timeout=10)
        if response.status_code == 200:
            data = response.json()
            print(f"âœ… Servidor funcionando - Status: {data.get('status')}")
            return True
        else:
            print("âŒ Servidor nÃ£o estÃ¡ respondendo adequadamente")
            return False
    except Exception as e:
        print(f"âŒ NÃ£o foi possÃ­vel conectar ao servidor: {e}")
        return False

def main():
    """
    Executa todos os testes
    """
    print("ğŸš€ Iniciando testes das URLs de PDF da API SmartBI\n")
    
    # Aguardar o servidor inicializar
    print("â³ Aguardando servidor inicializar...")
    time.sleep(3)
    
    # Testar se o servidor estÃ¡ funcionando
    if not test_health_endpoint():
        return
    
    # Testar arquivos estÃ¡ticos
    static_test = test_static_files()
    
    # Executar teste principal
    test_success = test_analyze_database_with_pdf()
    
    print(f"\nğŸ“Š Resumo dos testes:")
    print(f"   Servidor funcionando: âœ…")
    print(f"   Arquivos estÃ¡ticos: {'âœ… Sucesso' if static_test else 'âŒ Falhou'}")
    print(f"   PDF URLs geradas: {'âœ… Sucesso' if test_success else 'âŒ Falhou'}")
    
    if static_test and test_success:
        print("\nğŸ‰ Todos os testes passaram! As URLs de PDF estÃ£o funcionando.")
    else:
        print("\nâš ï¸ Alguns testes falharam. Verifique os logs acima.")

if __name__ == "__main__":
    main()