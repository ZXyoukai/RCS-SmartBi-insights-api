#!/usr/bin/env python3
"""
Script de teste para verificar se a formataÃ§Ã£o de quebras de linha estÃ¡ funcionando
"""

import asyncio
import sys
import os
import logging
from gemini_analyzer import GeminiAnalyzer

# Configurar logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

async def test_formatting():
    """
    Testa a funcionalidade de formataÃ§Ã£o de quebras de linha
    """
    try:
        logger.info("ğŸš€ Iniciando teste de formataÃ§Ã£o...")
        
        # Inicializar analisador
        analyzer = GeminiAnalyzer()
        
        # Verificar se estÃ¡ configurado
        if not analyzer.check_connection():
            logger.error("âŒ Erro na conexÃ£o com Gemini API")
            return False
        
        # Executar teste de formataÃ§Ã£o
        result = await analyzer.test_formatting()
        
        # Mostrar resultados
        print("\n" + "="*80)
        print("RESULTADOS DO TESTE DE FORMATAÃ‡ÃƒO")
        print("="*80)
        print(f"âœ… Teste executado com sucesso: {result['test_success']}")
        print(f"â±ï¸  Tempo de processamento: {result['processing_time']}s")
        print(f"ğŸ“Š Quebras de linha encontradas (\\n): {result['line_breaks_found']}")
        print(f"ğŸ“Š Tags <br> adicionadas: {result['br_tags_added']}")
        print(f"ğŸ¤– Modelo usado: {result['model_used']}")
        
        print(f"\nğŸ“ RESPOSTA ORIGINAL:")
        print("-"*40)
        print(repr(result['original_response'][:500]))  # Primeiros 500 caracteres
        
        print(f"\nğŸ”„ RESPOSTA FORMATADA:")
        print("-"*40)
        print(result['formatted_response'][:500])  # Primeiros 500 caracteres
        
        # Verificar se a conversÃ£o funcionou
        if result['line_breaks_found'] > 0 and result['br_tags_added'] >= result['line_breaks_found']:
            print(f"\nâœ… SUCESSO: {result['line_breaks_found']} quebras de linha foram convertidas para <br>")
            return True
        elif result['line_breaks_found'] == 0:
            print(f"\nâš ï¸  ATENÃ‡ÃƒO: A IA nÃ£o usou quebras de linha na resposta")
            return True
        else:
            print(f"\nâŒ ERRO: Nem todas as quebras de linha foram convertidas")
            return False
            
    except Exception as e:
        logger.error(f"âŒ Erro no teste: {e}")
        return False

if __name__ == "__main__":
    # Executar teste
    success = asyncio.run(test_formatting())
    
    if success:
        print(f"\nğŸ‰ Teste concluÃ­do com sucesso!")
        sys.exit(0)
    else:
        print(f"\nğŸ’¥ Teste falhou!")
        sys.exit(1)
