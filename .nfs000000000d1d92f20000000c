"""
Teste das rotas da API com verificaÃ§Ã£o de PDF
==========================================

Script para testar se as rotas estÃ£o retornando informaÃ§Ãµes do PDF
"""

import requests
import json
import time

def test_analyze_database():
    """
    Testa a rota /analyze-database
    """
    print("ğŸ§ª Testando rota /analyze-database...")
    
    url = "http://localhost:8000/analyze-database"
    payload = {
        "database_url": "postgresql://neondb_owner:iVdC1OxbWP99@ep-morning-hill-a5h6lsjm-pooler.us-east-2.aws.neon.tech/mapazzz?sslmode=require"
    }
    
    try:
        print("ğŸ“¡ Enviando requisiÃ§Ã£o...")
        response = requests.post(url, json=payload, timeout=60)
        
        if response.status_code == 200:
            data = response.json()
            print(f"âœ… Resposta recebida (Status: {response.status_code})")
            
            # Verificar se contÃ©m informaÃ§Ãµes de PDF
            pdf_info = {
                "pdf_generated": data.get("pdf_generated"),
                "pdf_path": data.get("pdf_path"),
                "pdf_filename": data.get("pdf_filename"),
                "pdf_error": data.get("pdf_error")
            }
            
            print(f"ğŸ“„ PDF Info: {json.dumps(pdf_info, indent=2)}")
            
            if pdf_info["pdf_generated"]:
                print(f"ğŸ‰ PDF gerado com sucesso: {pdf_info['pdf_filename']}")
                return True
            else:
                print(f"âŒ PDF nÃ£o foi gerado. Erro: {pdf_info.get('pdf_error', 'Desconhecido')}")
                return False
                
        else:
            print(f"âŒ Erro na requisiÃ§Ã£o: {response.status_code}")
            print(f"Resposta: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Erro no teste: {e}")
        return False

def test_specific_insights():
    """
    Testa a rota /specific-insights
    """
    print("\nğŸ§ª Testando rota /specific-insights...")
    
    url = "http://localhost:8000/specific-insights"
    payload = {
        "database_url": "postgresql://neondb_owner:iVdC1OxbWP99@ep-morning-hill-a5h6lsjm-pooler.us-east-2.aws.neon.tech/mapazzz?sslmode=require",
        "insight_request": "Analise os dados de usuÃ¡rios e relatÃ³rios para identificar padrÃµes de engajamento"
    }
    
    try:
        print("ğŸ“¡ Enviando requisiÃ§Ã£o...")
        response = requests.post(url, json=payload, timeout=60)
        
        if response.status_code == 200:
            data = response.json()
            print(f"âœ… Resposta recebida (Status: {response.status_code})")
            
            # Verificar se contÃ©m informaÃ§Ãµes de PDF
            pdf_info = {
                "pdf_generated": data.get("pdf_generated"),
                "pdf_path": data.get("pdf_path"),
                "pdf_filename": data.get("pdf_filename"),
                "pdf_error": data.get("pdf_error")
            }
            
            print(f"ğŸ“„ PDF Info: {json.dumps(pdf_info, indent=2)}")
            
            if pdf_info["pdf_generated"]:
                print(f"ğŸ‰ PDF gerado com sucesso: {pdf_info['pdf_filename']}")
                return True
            else:
                print(f"âŒ PDF nÃ£o foi gerado. Erro: {pdf_info.get('pdf_error', 'Desconhecido')}")
                return False
                
        else:
            print(f"âŒ Erro na requisiÃ§Ã£o: {response.status_code}")
            print(f"Resposta: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Erro no teste: {e}")
        return False

def main():
    """
    Executa todos os testes
    """
    print("ğŸš€ Iniciando testes das rotas da API SmartBI\n")
    
    # Aguardar o servidor inicializar
    print("â³ Aguardando servidor inicializar...")
    time.sleep(3)
    
    # Testar se o servidor estÃ¡ respondendo
    try:
        response = requests.get("http://localhost:8000/health", timeout=10)
        if response.status_code == 200:
            print("âœ… Servidor estÃ¡ rodando\n")
        else:
            print("âŒ Servidor nÃ£o estÃ¡ respondendo adequadamente")
            return
    except Exception as e:
        print(f"âŒ NÃ£o foi possÃ­vel conectar ao servidor: {e}")
        return
    
    # Executar testes
    test1_success = test_analyze_database()
    test2_success = test_specific_insights()
    
    print(f"\nğŸ“Š Resumo dos testes:")
    print(f"   /analyze-database: {'âœ… Sucesso' if test1_success else 'âŒ Falhou'}")
    print(f"   /specific-insights: {'âœ… Sucesso' if test2_success else 'âŒ Falhou'}")
    
    if test1_success and test2_success:
        print("\nğŸ‰ Todos os testes passaram! As rotas estÃ£o retornando informaÃ§Ãµes do PDF.")
    else:
        print("\nâš ï¸ Alguns testes falharam. Verifique os logs acima.")

if __name__ == "__main__":
    main()